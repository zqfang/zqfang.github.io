<p>A recipe for interactive computing using custom Jupyter kernels on Stanford’s Sherlock.</p>

<h2 id="setting-up-custom-conda-environment-on-sherlocks-login-node">Setting up custom conda environment on Sherlock’s login node</h2>
<h3 id="1-download-and-install-miniconda">1. Download and install Miniconda</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
<span class="c"># install</span>
bash Miniconda3-latest-Linux-x86_64.sh 
conda config <span class="nt">--set</span> always_yes <span class="nb">yes</span> 
</code></pre></div></div>

<h3 id="2-install-jupyter-notebooklab-and-secure-your-notebooks-with-a-password">2. Install jupyter notebook/lab and secure your notebooks with a password</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># install the default py3 kernel for jupyter notebook</span>
conda <span class="nb">install </span>ipython jupyter notebook jupyterlab
<span class="c"># add password</span>
jupyter notebook password
</code></pre></div></div>

<h3 id="3-optional-add-custom-conda-environment-ie-fastai">3. (Optional) Add custom conda environment. i.e. fastai</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda create <span class="nt">-n</span> fastai ipython ipykernel 
<span class="c"># add the custom to Jupyter notebook</span>
conda activate fastai
python <span class="nt">-m</span> ipykernel <span class="nb">install</span> <span class="nt">--user</span> <span class="nt">--name</span> fastai <span class="nt">--display-name</span> FastAI

</code></pre></div></div>
<p>you could also add R, Julia etc kernel.</p>

<h3 id="4-install-pytorchtensorflow">4. Install pytorch/tensorflow</h3>

<p>You should select the existed cuda version which installed in Sherlock</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda <span class="nb">install</span> <span class="nt">-c</span> pytorch pytorch torchvision <span class="nv">cudatoolkit</span><span class="o">=</span>10.1 
</code></pre></div></div>
<p>tensorflow</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda <span class="nb">install </span>tensorflow-gpu <span class="nv">cudatoolkit</span><span class="o">=</span>10.1
</code></pre></div></div>

<h3 id="5-load-gpu-modules-select-the-corresponding-cuda-version-youve-just-installed">5. Load gpu modules. Select the corresponding cuda version you’ve just installed</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># this is my version</span>
module load cuda/10.1.168
module load cudnn/7.6.4
module load nccl
</code></pre></div></div>

<h3 id="6-now-open-ipython-run">6. now, open ipython, run</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="k">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_avilable</span><span class="p">())</span>
</code></pre></div></div>
<p>if print out is <code class="highlighter-rouge">True</code>, then you’er OK to use GPUs.</p>

<h1 id="follow-these-steps-on-your-local-machine">Follow these steps on your local machine</h1>
<p>see details <a href="https://vsoch.github.io/lessons/sherlock-jupyter/">here</a>.</p>

<h3 id="7-download-the-forward-repo">7. Download the <code class="highlighter-rouge">forward</code> repo</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/vsoch/forward
<span class="nb">cd </span>forward
</code></pre></div></div>
<h3 id="8-generate-your-parameters">8. Generate your parameters</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash setup.sh
</code></pre></div></div>
<p>Select Sherlock partition: <span style="color: red">gpu</span></p>

<h3 id="9-ssh-credentials">9. SSH Credentials</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash hosts/sherlock_ssh.sh <span class="o">&gt;&gt;</span> ~/.ssh/config
</code></pre></div></div>

<h3 id="10-create-a-sbatch-script-in-forwardsbatchessherlock-and-save-as-jupyter-gpusbatch">10. create a sbatch script in forward/sbatches/sherlock and save as <code class="highlighter-rouge">jupyter-gpu.sbatch</code></h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">PORT</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">NOTEBOOK_DIR</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$NOTEBOOK_DIR</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">cd</span> <span class="nv">$SCRATCH</span>
<span class="k">else
    </span><span class="nb">cd</span> <span class="nv">$NOTEBOOK_DIR</span>
<span class="k">fi</span>

<span class="c">## to compile libtorch C++ code, load these modules</span>
<span class="c"># module load gcc/7.3.0</span>
<span class="c"># module load gdb</span>
<span class="c"># module load cmake</span>
<span class="c"># export CC=$(which gcc)</span>
<span class="c"># export CXX=$(which g++)</span>

<span class="c"># select cuda version you need</span>
module load cuda/10.1.168
module load cudnn/7.6.4
module load nccl

<span class="c"># activate fastai env </span>
<span class="nb">source </span>activate fastai 
jupyter lab <span class="nt">--no-browser</span> <span class="nt">--port</span><span class="o">=</span><span class="nv">$PORT</span>
</code></pre></div></div>

<h3 id="11-start-a-session">11. Start a session</h3>
<p>The default working directory is <code class="highlighter-rouge">$SCRATCH</code></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash start.sh jupyter-gpu
</code></pre></div></div>
<p>change the working directory</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash start.sh jupyter /path/to/dir
</code></pre></div></div>

<h3 id="12-open-your-browser-in-local-machine-and-type">12. open your browser in local machine and type</h3>

<p>if your port is 51888, then</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:51888/
</code></pre></div></div>
<p>here is my jupyter lab computing environment. Have fun!</p>

<p>fastai kernel</p>

<p><img src="/zqfang.github.io/images/sherlock.conda.png" alt="sherlock" /></p>

<p>Test GPUs</p>

<p><img src="/zqfang.github.io/images/sherlock.fastai.gpu.png" alt="fastai" /></p>

<h3 id="13-resume-a-session">13. Resume a session</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash resume.sh jupyter-gpu
<span class="c"># or</span>
bash resume.sh jupyter-gpu /path/to/dir
</code></pre></div></div>
<h3 id="14-stop-a-session">14. Stop a session</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash end.sh jupyter-gpu
<span class="c"># or</span>
bash end.sh jupyter-gpu /path/to/dir
</code></pre></div></div>

